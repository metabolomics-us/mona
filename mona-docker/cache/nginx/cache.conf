#our actual caching proxy
server {

            listen 80 default_server;
            server_name localhost;

            charset utf-8;

            #main pages
            location / {
		#access restrictions


                set $allow false;

                #genome center
                if ($http_x_real_ip ~ " ?128\.120\.([0-9])+\.([0-9])+.*$") {
                  set $allow true;
                }

                #sajjan home

                if ($http_x_real_ip ~ " ?99\.121\.202\.150.*$") {
                  set $allow true;
                }

                #mobilenet
                if ($http_x_real_ip ~ " ?168\.150\.([0-9])+\.([0-9])+.*$") {
                  set $allow true;
                }

                #gert home
                if ($http_x_real_ip ~ " ?104\.220\.39\.([0-9])+.*$") {
                  set $allow true;
                }

                #hiroshi japan
                if ($http_x_real_ip ~ " ?134\.160\.83\.126.*") {
                  set $allow true;
                }

                #tomas pluskal japan
                if ($http_x_real_ip ~ " ?203\.181\.243\.17.*") {
                  set $allow true;
                }

                #emma - schwitzerland
                if ($http_x_real_ip ~ " ?152\.88\.163\.185.*") {
                  set $allow true;
                }
                if ($http_x_real_ip ~ " ?152\.88\.152\.58.*") {
                  set $allow true;
                }

                #lets deny everything else!
                if ($allow = false) {
                  return 403;
                }

                proxy_cache one;

                #define how long objects should be cached by default
                proxy_cache_valid 404 500 1m;
                proxy_cache_valid 200 1m;
                proxy_cache_min_uses 1;

                add_header X-Proxy-Cache $upstream_cache_status;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_cache_use_stale updating;
                proxy_cache_lock on;
                proxy_cache_methods GET HEAD POST;

                proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
                proxy_hide_header      Set-Cookie;
                proxy_ignore_headers   Set-Cookie;

                #make sure we cache the post requests for rest services
                location /rest {
                        proxy_cache_key       "$uri|$request_body";
                        client_max_body_size  100k;

                        proxy_pass http://backends;
                }

                #never cache authentification
                location /rest/login {
                        proxy_no_cache 1;
                        proxy_cache_bypass 1;
                        proxy_pass http://backends;
                }

                #never cache authentification
                location /rest/logout {
                        proxy_no_cache 1;
                        proxy_cache_bypass 1;
                        proxy_pass http://backends;
                }


                #rest never cache rest/spectra/save responses
                location /rest/spectra/batch/save {
                        proxy_no_cache 1;
                        proxy_cache_bypass 1;
                        proxy_pass http://backends;
                }

                proxy_pass http://backends;
        }

        #here we are storing our statistics
        location /statistics {
                alias /var/cache/awstats;
                index index.html index.en.html;
                 autoindex on;
        }

        #location of stupid icons
        location /awstats-icon {
                alias /usr/share/awstats/icon;
        }
}
