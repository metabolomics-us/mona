<!--Splash for search-->
<div id="splash-page" *ngIf="searchSplash" class="dissolve-animation">
    <div class="page-splash">
        <div class="page-splash-message">
            Searching
            <span id="loadpulse">
                <div class="segment">
                    <div id="layer1" class="ball"></div>
                    <div id="layer7" class="pulse"></div>
                </div>
                <div class="segment">
                    <div id="layer2" class="ball"></div>
                    <div id="layer8" class="pulse"></div>
                </div>
                <div class="segment">
                    <div id="layer3" class="ball"></div>
                    <div id="layer9" class="pulse"></div>
                </div>
                <div class="segment">
                    <div id="layer4" class="ball"></div>
                    <div id="layer10" class="pulse"></div>
                </div>
            </span>
        </div>
    </div>
</div>

<toaster-container [toasterconfig]="toasterOptions"></toaster-container>

<div #error></div>

<div class="row">
    <div class="col-md-12">
        <ngb-accordion closeOthers="true" #acc="ngbAccordion">
            <ngb-panel id="display-panel">
                <ng-template ngbPanelHeader>Display Generated Query</ng-template>
                <ng-template ngbPanelContent>
                    Generated RSQL Query: <a [routerLink]="" (click)="editQuery = !editQuery"><i class="fa fa-pencil-square-o"></i></a>

                    <pre *ngIf="!editQuery">{{query !== '' && query !== undefined ? query : "[Empty Query]"}}</pre>
                    <div *ngIf="editQuery">
                        <form (submit)="updateQuery(query)">
                            <div class="input-group">
                                <input type="text" [(ngModel)]="query" class="form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-primary" type="submit">Update Query</button>
                                </span>
                            </div>
                        </form>
                    </div>

                    Full text search query:
                    <pre>{{textQuery}}</pre>

                    <div>
                        Example cURL command to download all spectral JSON records matching the generated RSQL query:
                        <pre>{{{query: query, text: textQuery} | curlPipe}}</pre>
                    </div>

                    <div>To download as an MSP file, add the header: <code>Accept: text/msp</code>.</div>

                    <div>
                        <strong>Note:</strong> Please refer to the <a [routerLink]="['/downloads']">downloads page</a> before starting large query
                        downloads to avoid putting unnecessary strain on the servers.
                    </div>
                </ng-template>
            </ngb-panel>
        </ngb-accordion>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="pull-left">
            <button class="btn btn-primary"
                    *ngIf="pagination.table == false" (click)="pagination.table = true; setTable()"
                    placement="right"
                    ngbTooltip="Display Spectra in Tabular Mode"
                    triggers="mouseenter" openDelay="2" closeDelay="2">
                <i class="fa fa-2x fa-table fa-fw"></i>
            </button>

            <button class="btn btn-primary"
                    *ngIf="pagination.table == true" (click)="pagination.table = false; setTable()"
                    placement="right"
                    ngbTooltip="Display Spectra in Panel Mode"
                    triggers="mouseenter" openDelay="2" closeDelay="2">
                <i class="fa fa-2x fa-list fa-fw"></i>
            </button>

            <button class="btn btn-primary" (click)="searchSpectra()" placement="right"
                    ngbTooltip="Start a New Query"
                    triggers="mouseenter" openDelay="2" closeDelay="2">
                <i class="fa fa-2x fa-search fa-fw"></i>
            </button>

            <button class="btn btn-primary" (click)="resetQuery()" placement="right"
                    ngbTooltip="Reset the Current Query" triggers="mouseenter" openDelay="2" closeDelay="2">
                <i class="fa fa-2x fa-refresh fa-fw"></i>
            </button>
        </div>

        <div class="pull-right">
            <!--
            <div ng-show="auth.isLoggedIn()" spectra-download></div>
            -->

            <button class="btn btn-primary" (click)="acc.isExpanded('display-panel')? acc.collapse('display-panel'): acc.expand('display-panel')" placement="left"
                    ngbTooltip="Number of spectra retrieved in this query, click to see additional details">

                <i class="fa fa-2x fa-slack fa-fw vcenter"></i>{{pagination.totalSize > -1 ? pagination.totalSize : "Loading..."}}
                <span *ngIf="authenticationService.isAdmin() && duration !== undefined"> ({{duration | number: '1.2-2'}} s)</span>
            </button>
        </div>
    </div>
</div>

<div class="row top7">
    <div class="col-md-12">
        <div ngbDropdown class="d-inline-block">
            <button class="btn btn-primary" ngbDropdownToggle>
                Records Per Page
            </button>
            <div ngbDropdownMenu>
                <button *ngFor="let option of pagination.itemsPerPageOptions" ngbDropdownItem>{{option+' records/page'}}</button>
            </div>

        </div>
        <!--
        <select data-multi-select
                data-ng-model="$ctrl.pagination.itemsPerPageSelection"
                data-buttonClass="btn btn-primary"
                data-ng-options="option.toString() as option + ' records/page' for option in pagination.itemsPerPageOptions">
        </select>

        <select data-multi-select
                multiple
                data-ng-if="$ctrl.pagination.table == true"
                data-ng-model="$ctrl.pagination.tableColumnSelected"
                data-buttonClass="btn btn-primary"
                data-buttonText="Select Columns"
                data-enableFiltering="true"
                data-ng-options="option for option in pagination.tableColumnOptions">
        </select> -->
    </div>
</div>

<div class="row top17">
    <!-- display spectra as list -->
    <div class="col-md-12" *ngIf="pagination.table == false">
        <div *ngFor="let spectrum of spectra">
            <display-spectra-panel [spectrum]="spectrum"></display-spectra-panel>
        </div>
    </div>

    <!-- display spectra as table-->
    <div class="col-md-12" *ngIf="pagination.table == true">
        <table class="table table-hover table-striped" style="table-layout: fixed;">
            <thead>
            <tr>
                <th *ngFor="let column of pagination.tableColumnSelected"
                    [ngClass]="{'text-center': column != 'ID' && column != 'Name'}">{{column}}</th>
            </tr>
            </thead>

            <tbody>
            <tr *ngIf="spectra.length == 0"></tr>

            <tr *ngFor="let spectrum of spectra; index as i" (click)="viewSpectrum(spectrum.id, i)">
                <td *ngFor="let column of  pagination.tableColumnSelected" [ngSwitch]="column">
                    <div *ngSwitchCase="'ID'">
                        <div><a style="cursor: pointer" [routerLink]="[viewSpectrum(spectrum.id, i)]">{{spectrum.id}}</a></div>
                        <div>
                            <ngb-rating [(rate)]="spectrum.score.score" max="5" readonly="true"></ngb-rating>
                        </div>
                        <div *ngIf="spectrum.similarity !== undefined">
                            <h4><span class="label label-primary" >Similarity: {{spectrum.similarity * 1000 | number:'1.0-0'}}</span></h4>
                        </div>
                    </div>

                    <div *ngSwitchCase="'Name'">
                        <ul class="list-unstyled">
                            <li *ngFor="let name of spectrum.compound[0].names | slice:0:3">{{name.name}}</li>
                        </ul>
                    </div>

                    <div *ngSwitchCase="'Structure'" class="text-center" style="width:200px;height:200px">
                        <div [libChemdoodle]="spectrum.compound[0].molFile" class="center-block" readonly="true"
                             [id]="'bioSketch_'+spectrum.id+'_true'"></div>
                    </div>

                    <div *ngSwitchCase="'Mass Spectrum'" class="text-center">
                        <div class="masspec-mini">
                            <lib-ng-mass-spec-plotter [id]="'massSpec_'+spectrum.id" [miniPlot]="true" [spectrum]="spectrum.spectrum"></lib-ng-mass-spec-plotter>
                        </div>
                    </div>

                    <div *ngSwitchCase="'Accurate Mass'">
                        <p class="text-center">{{spectrum.metaDataMap['total exact mass']}}</p>
                    </div>

                    <div *ngSwitchDefault>
                        <p class="text-center">{{spectrum.metaDataMap[column]}}</p>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>


    <!-- loading information -->
    <div class="text-center" *ngIf="pagination.loading && !searchSplash">
        <h4 class="spinner"><i class="fa fa-refresh fa-spin"></i> Loading...</h4>
    </div>

    <div class="text-center" *ngIf="!pagination.loading && spectra.length == 0">
        <h4>No results found!</h4>
    </div>

    <!-- pagination -->
    <div *ngIf="!pagination.loading && pagination.totalSize > -1" class="text-center">
        <ngb-pagination
            [collectionSize]="pagination.totalSize"
            [maxSize]="pagination.maxSize"
            [pageSize]="pagination.itemsPerPage"
            [(page)]="pagination.currentPage"
            [boundaryLinks]="true"
            (pageChange)="loadPage()"></ngb-pagination>
    </div>

    <!-- spacer -->
    <div class="top17">&nbsp;</div>
</div>
